<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eisenhower Matrix SPA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            900: '#1e3a8a',
                        },
                        q1: { light: '#fee2e2', border: '#ef4444', text: '#ef4444', bg: '#fef2f2', tint: 'rgba(239, 68, 68, 0.05)' },
                        q2: { light: '#e0f2fe', border: '#0ea5e9', text: '#0ea5e9', bg: '#f0f9ff', tint: 'rgba(14, 165, 233, 0.05)' },
                        q3: { light: '#dcfce7', border: '#22c55e', text: '#22c55e', bg: '#f0fdf4', tint: 'rgba(34, 197, 94, 0.05)' },
                        q4: { light: '#f3f4f6', border: '#9ca3af', text: '#9ca3af', bg: '#f9fafb', tint: 'rgba(156, 163, 175, 0.05)' },
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                        'lift': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04)',
                        'highlight': '0 0 15px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; transition: background-color 0.3s; }
        .dark body { background-color: #0b0f1a; }

        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #334155; }

        .dragging { opacity: 0.4; transform: scale(0.98); cursor: grabbing; }
        
        .drag-over { 
            background-color: rgba(59, 130, 246, 0.05) !important; 
            position: relative;
        }
        .drag-over::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 2px dashed #3b82f6;
            border-radius: 1rem;
            pointer-events: none;
            z-index: 50;
        }
        .dark .drag-over { background-color: rgba(59, 130, 246, 0.1) !important; }
        
        [contenteditable="true"] { cursor: text; }
        .is-editing-text {
            background-color: #ffffff;
            border: 1px solid #3b82f6;
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .dark .is-editing-text { background-color: #1e293b; color: white; border-color: #60a5fa; }
        
        .task-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .animate-fade-in { animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-panel { width: 320px; min-width: 320px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900 dark:text-slate-200">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-6 py-3 flex items-center justify-between shrink-0 z-20 shadow-sm relative transition-colors">
        <div class="flex items-center gap-4">
            <div class="bg-brand-600 text-white p-2 rounded-lg shadow-sm">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white leading-none">Eisenhower Matrix</h1>
                <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest mt-1">Productivity Hub</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Data Actions -->
            <button data-action="export-json" class="flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-bold uppercase tracking-wider text-slate-500 hover:text-brand-600 transition-colors" title="Export Data">
                <i data-lucide="download" class="w-3.5 h-3.5"></i> Export
            </button>
            <label class="flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-bold uppercase tracking-wider text-slate-500 hover:text-brand-600 transition-colors cursor-pointer" title="Import Data">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> Import
                <input type="file" id="import-input" accept=".json" class="hidden">
            </label>
            
            <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>

            <button id="theme-toggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-500 dark:text-slate-400" title="Toggle Theme">
                <i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i>
            </button>
            <div class="text-[11px] font-bold px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 shadow-sm">
                <span id="task-count" class="text-brand-600 dark:text-brand-400">0</span> Tasks
            </div>
        </div>
    </header>

    <!-- Main App Layout -->
    <div id="app" class="flex-1 flex overflow-hidden relative dark:bg-slate-950"></div>

    <script>
        const STORAGE_KEY = 'eisenhower_matrix_v8_state';

        // --- 1. STATE MANAGEMENT ---
        const defaultState = {
            tasks: [
                { id: '1', text: 'Review quarterly goals and objectives', location: 'q1', completed: false, created: Date.now(), completedAt: null, isHighlighted: true, dueDate: null },
                { id: '2', text: 'Weekly sync with the engineering team', location: 'inbox', completed: false, created: Date.now(), completedAt: null, isHighlighted: false, dueDate: null },
            ],
            notes: "Quick scratchpad for thoughts...",
            quadrants: {
                q1: { title: 'Do First', subtitle: 'Urgent & Important' },
                q2: { title: 'Schedule', subtitle: 'Not Urgent & Important' },
                q3: { title: 'Delegate', subtitle: 'Urgent & Not Important' },
                q4: { title: 'Don\'t Do', subtitle: 'Not Urgent & Not Important' }
            },
            isDarkMode: false,
            draggedTaskId: null,
            editingId: null,
            datePickingId: null,
            showClearModal: false
        };

        const savedState = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const state = savedState ? { ...defaultState, ...savedState, draggedTaskId: null, editingId: null, datePickingId: null, showClearModal: false } : defaultState;

        const QUADRANT_STYLE = {
            q1: { accent: '#ef4444', text: 'text-red-500', tint: 'dark:bg-red-950/10' },
            q2: { accent: '#0ea5e9', text: 'text-blue-500', tint: 'dark:bg-blue-950/10' },
            q3: { accent: '#22c55e', text: 'text-green-500', tint: 'dark:bg-green-950/10' },
            q4: { accent: '#9ca3af', text: 'text-slate-400', tint: 'dark:bg-slate-900/50' }
        };

        function updateState(updates) {
            Object.assign(state, updates);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            render();
        }

        // --- 2. HELPERS ---
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                }
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function formatDate(timestamp) {
            const d = new Date(timestamp);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function exportToJSON() {
            // Remove ephemeral UI states before exporting
            const cleanState = { ...state };
            delete cleanState.draggedTaskId;
            delete cleanState.editingId;
            delete cleanState.datePickingId;
            delete cleanState.showClearModal;

            const dataStr = JSON.stringify(cleanState, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `eisenhower-matrix-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            document.body.appendChild(linkElement); // Required for some browsers
            linkElement.click();
            document.body.removeChild(linkElement);
        }

        function importFromJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (importedState.tasks && Array.isArray(importedState.tasks)) {
                        updateState({ 
                            ...importedState, 
                            draggedTaskId: null, 
                            editingId: null, 
                            datePickingId: null,
                            showClearModal: false
                        });
                    }
                } catch (err) {
                    alert("Invalid JSON file provided.");
                }
            };
            reader.readAsText(file);
        }

        // --- 3. COMPONENT FUNCTIONS ---
        
        function ClearHistoryModal() {
            return `
                <div class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-80 p-8 transform transition-all scale-100 border border-slate-100 dark:border-slate-700">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mb-5">
                                <i data-lucide="trash-2" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-base font-bold text-slate-800 dark:text-white mb-2">Clear History?</h3>
                            <div class="flex flex-col gap-3 w-full mt-4">
                                <button class="w-full px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white font-bold text-xs rounded-xl shadow-sm transition-colors" data-action="confirm-clear">Clear All</button>
                                <button class="w-full px-4 py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-bold text-xs rounded-xl transition-colors" data-action="cancel-clear">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function TaskItem(task) {
            const isEditing = state.editingId === task.id;
            const isPickingDate = state.datePickingId === task.id;
            const highlightedClasses = task.isHighlighted ? 'ring-2 ring-brand-500 shadow-highlight dark:ring-brand-400 bg-brand-50/30 dark:bg-brand-900/10' : '';
            
            return `
                <div 
                    class="task-card group bg-white dark:bg-slate-800 p-3 rounded-xl shadow-card mb-3 border border-transparent hover:border-slate-200 dark:hover:border-slate-700 relative ${isEditing ? 'ring-2 ring-brand-500 dark:ring-brand-400 z-10' : ''} ${highlightedClasses}"
                    draggable="${!(isEditing || isPickingDate)}" 
                    data-id="${task.id}"
                >
                    <div class="flex items-start gap-1 w-full relative">
                        <!-- Drag Grip: Vertical alignment fixed -->
                        <div class="shrink-0 mt-[5.5px] opacity-0 group-hover:opacity-30 cursor-grab active:cursor-grabbing px-0.5 transition-opacity">
                            <i data-lucide="grip-vertical" class="w-3.5 h-3.5 text-slate-500"></i>
                        </div>

                        <!-- Checkbox -->
                        <button class="shrink-0 mt-[4px] mr-1 text-slate-300 dark:text-slate-600 hover:text-green-500 transition-colors" data-action="complete" data-id="${task.id}" title="Complete" ${isEditing ? 'disabled style="opacity:0.2"' : ''}>
                            <i data-lucide="circle" class="w-5 h-5"></i>
                        </button>

                        <!-- Text Area -->
                        <div class="flex-1 min-w-0 pr-1">
                            <span 
                                class="text-[13px] font-semibold leading-relaxed text-slate-700 dark:text-slate-200 outline-none block break-words py-0.5 ${isEditing ? 'is-editing-text' : ''}"
                                contenteditable="${isEditing}"
                                data-type="task-text"
                                data-id="${task.id}"
                            >${task.text}</span>
                        </div>

                        <!-- Icons -->
                        <div class="shrink-0 flex items-center gap-0.5 mt-[3.5px] ml-1 transition-opacity duration-200 ${isEditing || isPickingDate ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}">
                            <button class="p-1 rounded-md transition-all ${task.isHighlighted ? 'opacity-100 text-brand-500' : 'text-slate-400 hover:text-brand-500'}" data-action="highlight" data-id="${task.id}">
                                <i data-lucide="star" class="w-3.5 h-3.5 ${task.isHighlighted ? 'fill-current' : ''}"></i>
                            </button>
                            <button class="p-1 rounded-md transition-all ${isEditing ? 'text-white bg-brand-600 shadow-sm' : 'text-slate-400 hover:text-brand-500'}" data-action="edit" data-id="${task.id}">
                                <i data-lucide="${isEditing ? 'check' : 'pencil'}" class="w-3.5 h-3.5"></i>
                            </button>
                            <button class="p-1 rounded-md transition-all ${isPickingDate ? 'text-brand-600 bg-brand-50' : 'text-slate-400 hover:text-brand-500'}" data-action="toggle-date-picker" data-id="${task.id}">
                                <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                            </button>
                            ${!(isEditing || isPickingDate) ? `<button class="p-1 rounded-md text-slate-400 hover:text-red-500" data-action="delete" data-id="${task.id}"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : ''}
                        </div>

                        ${task.isHighlighted && !isEditing && !isPickingDate ? `
                            <div class="absolute right-0 top-[3.5px] p-1 text-brand-500 group-hover:hidden"><i data-lucide="star" class="w-3.5 h-3.5 fill-current"></i></div>
                        ` : ''}
                    </div>

                    <!-- Date Indented to align with text -->
                    <div class="mt-1 ml-11">
                        ${task.dueDate ? `<div class="text-[10px] text-brand-600 dark:text-brand-400 font-bold flex items-center gap-1 bg-brand-50/50 dark:bg-brand-900/20 w-max px-2 py-0.5 rounded-md"><i data-lucide="calendar" class="w-3 h-3"></i> Due: ${task.dueDate.split('-').reverse().join('.')}</div>` : ''}
                        
                        ${(isEditing || isPickingDate) ? `
                            <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700 flex flex-col gap-2 animate-fade-in">
                                <div class="flex items-center justify-between">
                                    <label class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Due Date</label>
                                    ${isPickingDate && !isEditing ? `<button class="text-[10px] font-bold text-brand-600" data-action="close-date">Done</button>` : ''}
                                </div>
                                <input type="date" class="bg-slate-50 dark:bg-slate-900 text-[11px] p-2 rounded-lg border border-slate-200 dark:border-slate-700 outline-none w-full" value="${task.dueDate || ''}" data-type="task-due-date" data-id="${task.id}">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function CompletedTaskItem(task) {
            const dateStr = task.completedAt ? formatDate(task.completedAt) : '';
            return `
                <div class="flex items-start gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm shrink-0 w-64 mr-3 relative group">
                    <div class="mt-0.5 text-green-500 shrink-0"><i data-lucide="check-circle-2" class="w-4 h-4"></i></div>
                    <div class="min-w-0 flex-1">
                        <span class="text-[12px] font-medium text-slate-400 dark:text-slate-500 line-through decoration-slate-300 dark:decoration-slate-700 block truncate leading-tight">${task.text}</span>
                        ${dateStr ? `<div class="text-[9px] text-slate-400 dark:text-slate-600 font-bold mt-1 tracking-tight">${dateStr}</div>` : ''}
                    </div>
                    <button class="absolute -top-2 -right-2 bg-slate-100 dark:bg-slate-700 text-slate-400 hover:text-brand-600 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-full shadow-sm" data-action="restore" data-id="${task.id}">
                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
        }

        function LeftPanel() {
            const inboxTasks = state.tasks.filter(t => t.location === 'inbox' && !t.completed);
            return `
                <div class="sidebar-panel bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col h-full z-10 transition-colors">
                    <div class="flex flex-col h-3/5 border-b border-slate-200 dark:border-slate-800 relative">
                        <div class="p-5 pb-2">
                            <h2 class="text-base font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-1">Inbox <span class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] px-2 py-0.5 rounded-full font-bold">${inboxTasks.length}</span></h2>
                        </div>
                        <div class="px-5 py-3 shrink-0">
                            <div class="relative group">
                                <input type="text" placeholder="Add task..." class="w-full pl-4 pr-10 py-3 text-sm bg-white dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm focus:outline-none focus:ring-4 focus:ring-brand-500/10 transition-all placeholder:text-slate-400" id="inbox-input" autocomplete="off">
                                <button class="absolute right-2 top-2 bottom-2 aspect-square flex items-center justify-center bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-all shadow-sm" data-action="add-inbox"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto px-5 pb-6 pt-2 custom-scroll relative" data-droppable="true" data-location="inbox">
                            ${inboxTasks.length ? inboxTasks.map(TaskItem).join('') : `<div class="h-32 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl mt-2 text-slate-400 dark:text-slate-700 font-bold text-[10px] uppercase tracking-widest">Empty</div>`}
                        </div>
                    </div>
                    <div class="flex flex-col h-2/5">
                        <div class="p-5 pb-2"><h3 class="font-bold text-slate-800 dark:text-white text-[11px] flex items-center gap-2.5"><i data-lucide="sticky-note" class="w-3.5 h-3.5 text-yellow-500"></i> Scratchpad</h3></div>
                        <div class="px-5 pb-5 flex-1">
                            <textarea class="w-full h-full p-4 resize-none text-[13px] font-medium leading-relaxed text-slate-600 dark:text-slate-400 bg-yellow-50/20 dark:bg-slate-800/30 rounded-xl border border-yellow-200/30 dark:border-slate-700 focus:outline-none focus:ring-4 focus:ring-yellow-400/10 transition-all custom-scroll" id="notes-area" placeholder="Jot down ideas...">${state.notes}</textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        function MatrixQuadrant(key) {
            const dynamicConfig = state.quadrants[key];
            const style = QUADRANT_STYLE[key];
            const tasks = state.tasks.filter(t => t.location === key && !t.completed);
            
            return `
                <div class="flex flex-col h-full rounded-[1.5rem] bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 shadow-sm overflow-hidden group hover:shadow-md transition-all min-w-0 ${style.tint}" style="border-top: 4px solid ${style.accent}">
                    <div class="px-4 py-3 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50 transition-colors">
                        <div class="flex-1 mr-2 min-w-0">
                            <h3 class="font-bold text-xs text-slate-800 dark:text-white outline-none hover:bg-black/5 dark:hover:bg-white/5 rounded px-1 -ml-1 transition-colors cursor-text truncate block" contenteditable="true" data-type="quadrant-title" data-key="${key}">${dynamicConfig.title}</h3>
                            <p class="text-[9px] font-bold uppercase tracking-[0.1em] mt-0.5 outline-none hover:bg-black/5 dark:hover:bg-white/5 rounded px-1 -ml-1 transition-colors cursor-text block ${style.text}" contenteditable="true" data-type="quadrant-subtitle" data-key="${key}">${dynamicConfig.subtitle}</p>
                        </div>
                        <span class="bg-white/80 dark:bg-slate-700 px-2 py-0.5 rounded-full text-[9px] font-black text-slate-600 dark:text-slate-300 ring-1 ring-black/5 shadow-sm shrink-0">${tasks.length}</span>
                    </div>
                    <div class="flex-1 p-3 overflow-y-auto custom-scroll relative group" data-droppable="true" data-location="${key}">
                        ${tasks.length ? tasks.map(TaskItem).join('') : `<div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-300"><span class="text-[10px] text-slate-300 dark:text-slate-700 font-black uppercase tracking-widest">Drop here</span></div>`}
                    </div>
                </div>
            `;
        }

        function HistorySection() {
            const completedTasks = state.tasks.filter(t => t.completed);
            const completedList = [...completedTasks].sort((a, b) => b.completedAt - a.completedAt);
            return `
                <div class="h-32 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex flex-col shrink-0">
                    <div class="px-6 py-1.5 border-b border-slate-50 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-900/80">
                        <h3 class="font-bold text-slate-400 dark:text-slate-500 text-[10px] uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="archive" class="w-3 h-3"></i> Logged History
                        </h3>
                        ${completedTasks.length > 0 ? `<button class="text-[9px] font-black uppercase tracking-wider text-red-400 hover:text-red-500" data-action="clear-completed">Clear History</button>` : ''}
                    </div>
                    <div class="flex-1 overflow-x-auto overflow-y-hidden p-4 flex items-center custom-scroll bg-white dark:bg-slate-950/20">
                        ${completedList.length ? completedList.map(CompletedTaskItem).join('') : '<div class="text-[10px] text-slate-300 dark:text-slate-700 font-bold uppercase tracking-widest w-full text-center">No history recorded</div>'}
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            const root = document.documentElement;
            if (state.isDarkMode) root.classList.add('dark'); else root.classList.remove('dark');

            app.innerHTML = `
                ${state.showClearModal ? ClearHistoryModal() : ''}
                ${LeftPanel()}
                <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
                    <div class="flex-1 p-5 bg-slate-100/30 dark:bg-slate-950 overflow-hidden relative">
                        <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 24px 24px;"></div>
                        <div class="grid grid-cols-2 grid-rows-2 gap-5 h-full relative z-0">
                            ${MatrixQuadrant('q1')} ${MatrixQuadrant('q2')} ${MatrixQuadrant('q3')} ${MatrixQuadrant('q4')}
                        </div>
                    </div>
                    ${HistorySection()}
                </div>
            `;

            lucide.createIcons();
            document.getElementById('task-count').innerText = state.tasks.filter(t => !t.completed).length;
        }

        function setupEventListeners() {
            // Document-level listener for header and dynamic buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('button') || e.target.closest('[data-action]');
                if (!btn) return;
                const { action, id } = btn.dataset;

                if (action === 'complete') {
                    const idx = state.tasks.findIndex(t => t.id === id);
                    if (idx > -1) {
                        const newTasks = [...state.tasks];
                        newTasks[idx].completed = true;
                        newTasks[idx].completedAt = Date.now();
                        updateState({ tasks: newTasks });
                    }
                } else if (action === 'delete') {
                    updateState({ tasks: state.tasks.filter(t => t.id !== id) });
                } else if (action === 'restore') {
                    const idx = state.tasks.findIndex(t => t.id === id);
                    if (idx > -1) {
                        const newTasks = [...state.tasks];
                        newTasks[idx].completed = false;
                        newTasks[idx].completedAt = null;
                        updateState({ tasks: newTasks });
                    }
                } else if (action === 'clear-completed') {
                    updateState({ showClearModal: true });
                } else if (action === 'confirm-clear') {
                    updateState({ tasks: state.tasks.filter(t => !t.completed), showClearModal: false });
                } else if (action === 'cancel-clear') {
                    updateState({ showClearModal: false });
                } else if (action === 'add-inbox') {
                    addTaskFromInput();
                } else if (action === 'edit') {
                    state.editingId = state.editingId === id ? null : id;
                    state.datePickingId = null;
                    render();
                } else if (action === 'highlight') {
                    const idx = state.tasks.findIndex(t => t.id === id);
                    if (idx > -1) {
                        const newTasks = [...state.tasks];
                        newTasks[idx].isHighlighted = !newTasks[idx].isHighlighted;
                        updateState({ tasks: newTasks });
                    }
                } else if (action === 'toggle-date-picker') {
                    state.datePickingId = state.datePickingId === id ? null : id;
                    render();
                } else if (action === 'close-date') {
                    state.datePickingId = null;
                    render();
                } else if (action === 'export-json') {
                    exportToJSON();
                }
            });

            document.getElementById('theme-toggle').addEventListener('click', () => {
                updateState({ isDarkMode: !state.isDarkMode });
            });

            document.getElementById('import-input').addEventListener('change', (e) => {
                if (e.target.files.length) importFromJSON(e.target.files[0]);
            });

            // Handle Input/Text Changes
            document.addEventListener('input', (e) => {
                if (e.target.id === 'notes-area') {
                    state.notes = e.target.value;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.target.id === 'inbox-input' && e.key === 'Enter') addTaskFromInput();
                if (e.target.isContentEditable && e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
            });

            document.addEventListener('focusout', (e) => {
                const el = e.target;
                if (!el.isContentEditable) return;
                const type = el.dataset.type;
                
                if (type === 'task-text') {
                    const text = el.innerText.trim();
                    const idx = state.tasks.findIndex(t => t.id === el.dataset.id);
                    if (idx > -1) {
                        const newTasks = [...state.tasks];
                        newTasks[idx].text = text || "New Task";
                        if (!(e.relatedTarget?.dataset.action === 'edit')) state.editingId = null;
                        updateState({ tasks: newTasks });
                    }
                } else if (type.includes('quadrant')) {
                    const key = el.dataset.key;
                    const prop = type === 'quadrant-title' ? 'title' : 'subtitle';
                    state.quadrants[key][prop] = el.innerText.trim();
                    updateState({ quadrants: { ...state.quadrants } });
                }
            });

            document.addEventListener('change', (e) => {
                if (e.target.dataset.type === 'task-due-date') {
                    const id = e.target.dataset.id;
                    const idx = state.tasks.findIndex(t => t.id === id);
                    if (idx > -1) {
                        const newTasks = [...state.tasks];
                        newTasks[idx].dueDate = e.target.value;
                        updateState({ tasks: newTasks });
                    }
                }
            });

            // Drag/Drop logic
            document.addEventListener('dragstart', (e) => {
                const taskEl = e.target.closest('[draggable="true"]');
                if (taskEl) {
                    state.draggedTaskId = taskEl.dataset.id;
                    taskEl.classList.add('dragging');
                }
            });
            document.addEventListener('dragend', (e) => {
                const taskEl = e.target.closest('[draggable="true"]');
                if (taskEl) taskEl.classList.remove('dragging');
                state.draggedTaskId = null;
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dropZone = e.target.closest('[data-droppable="true"]');
                if (dropZone) dropZone.classList.add('drag-over');
            });
            document.addEventListener('dragleave', (e) => {
                const dropZone = e.target.closest('[data-droppable="true"]');
                if (dropZone && !dropZone.contains(e.relatedTarget)) dropZone.classList.remove('drag-over');
            });
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                const dropZone = e.target.closest('[data-droppable="true"]');
                if (dropZone && state.draggedTaskId) {
                    const newLocation = dropZone.dataset.location;
                    const afterElement = getDragAfterElement(dropZone, e.clientY);
                    const draggedTask = state.tasks.find(t => t.id === state.draggedTaskId);
                    const otherTasks = state.tasks.filter(t => t.id !== state.draggedTaskId);
                    if (draggedTask) {
                        draggedTask.location = newLocation;
                        if (afterElement == null) otherTasks.push(draggedTask);
                        else {
                            const insertIndex = otherTasks.findIndex(t => t.id === afterElement.dataset.id);
                            otherTasks.splice(insertIndex, 0, draggedTask);
                        }
                        updateState({ tasks: otherTasks });
                    }
                }
            });
        }

        function addTaskFromInput() {
            const input = document.getElementById('inbox-input');
            const text = input.value.trim();
            if (!text) return;
            const newTask = { id: Date.now().toString(), text, location: 'inbox', completed: false, created: Date.now(), completedAt: null, isHighlighted: false, dueDate: null };
            updateState({ tasks: [...state.tasks, newTask] });
            input.value = '';
        }

        document.addEventListener('DOMContentLoaded', () => { render(); setupEventListeners(); });
    </script>
</body>
</html>
